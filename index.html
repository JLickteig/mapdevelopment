<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Salas O'Brien Offices Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- MapLibre -->
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Pickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

  <!-- Turf -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <style>
    :root {
      --brand: #009de0;
      --bg: #ffffff;
      --text: #111;
      --muted: #666;
      --line: #e5e7eb;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); }
    #map { position: absolute; inset: 0; }
    #panel {
      position: absolute; top: 14px; left: 14px;
      width: 320px; max-height: calc(100vh - 28px); overflow: auto;
      background: var(--bg); border: 1px solid var(--line);
      border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 14px; z-index: 5;
    }
    .panel-section { border: 1px solid var(--line); border-radius: 12px; padding: 12px; margin-bottom: 12px; background: #fff; }
    .section-title { font-weight: 600; font-size: 14px; margin: 0 0 8px 0; display: flex; align-items: center; gap: 8px; }
    .hr { height: 1px; background: var(--line); margin: 12px 0; }
    .so-btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 10px 14px;
      font-size: 14px; color: #000; background: #fff; border: 2px solid var(--brand); border-radius: 999px; cursor: pointer; }
    .so-btn:hover { background: var(--brand); color: #fff; }
    select { width: 100%; min-height: 160px; font-size: 13px; }
    .map-legend { position: absolute; left: 50%; transform: translateX(-50%); bottom: 14px; background: transparent;
      border: none; box-shadow: none; border-radius: 10px; padding: 8px 10px; z-index: 4; max-width: min(90%, 900px); }
    #legendItems { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px 16px; }
    .legend-item { display: inline-flex; align-items: center; gap: 6px; }
    .legend-swatch { width: 14px; height: 14px; border-radius: 3px; display: inline-block; }
  </style>
</head>
<body>
  <aside id="panel">
    <div class="panel-section">
      <div class="section-title">Coverage (3-hour drive)</div>
      <div class="segmented" role="group">
        <button id="reachOff" class="active">Hide Reach</button>
        <button id="reachOn">Show Reach</button>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-title">Filters</div>
      <label>State / Province</label>
      <select id="regionFilter" multiple></select>
      <button class="so-btn" id="clearRegion">Clear</button>

      <label>Business Unit</label>
      <select id="buFilter" multiple size="6"></select>
      <button class="so-btn" id="clearBU">Clear</button>
      <div class="hr"></div>
      <button class="so-btn" id="clearFilters">Clear All Filters</button>
    </div>

    <div class="panel-section" id="layersSection">
      <div class="section-title">Layers</div>
      <div id="uploadLayers"></div>
      <button class="so-btn" id="addLayerBtn">+ Add Layer</button>
    </div>

    <div class="panel-section">
      <button class="so-btn" id="exportMap">Export Map as PNG</button>
      <button class="so-btn" id="revertMap" style="margin-top:8px;">Revert to Base Map</button>
    </div>
  </aside>

  <div id="map"></div>
  <div id="legend" class="map-legend" style="display:none;">
    <div id="legendItems"></div>
  </div>

  <script>
    const MAP_STYLE = "https://api.maptiler.com/maps/01997743-cfd2-751b-8d35-2d71fee39521/style.json?key=8V0rViEioVaen5HD4wBV";
    const DATA_URL = "https://script.google.com/macros/s/AKfycbzBqCDOsIyd9D8gn274QEv7clyilhQuqudXFzeo9xuDNEzQZXNtnQ9ImKg01sjJk9CF/exec";

    const map = new maplibregl.Map({
      container: "map",
      style: MAP_STYLE,
      center: [-98.5795, 39.8283],
      zoom: 3,
      preserveDrawingBuffer: true
    });

    // ðŸ‘‡ Lambert projection
    map.setProjection({ name: "lambertConformalConic" });

    map.addControl(new maplibregl.NavigationControl(), "bottom-right");

    const OFFICE_SOURCE = "offices";
    const OFFICE_LAYER = "offices-layer";
    const HALO_SOURCE = "halo-offices";
    const HALO_LAYER = "halo-offices-fill";

    let originalGeojson = null;
    let reachEnabled = false;

    const emptyFC = () => ({ type: "FeatureCollection", features: [] });

    function ensureHaloLayer() {
      if (!map.getSource(HALO_SOURCE)) {
        map.addSource(HALO_SOURCE, { type: "geojson", data: emptyFC() });
      }
      if (!map.getLayer(HALO_LAYER)) {
        map.addLayer({ id: HALO_LAYER, type: "fill", source: HALO_SOURCE,
          paint: { "fill-color": "#009de0", "fill-opacity": 0.2 } });
      }
    }
    function setHaloData(fc) {
      const src = map.getSource(HALO_SOURCE);
      if (src) src.setData(fc);
    }
    async function rebuildOfficeHalos(data) {
      if (!reachEnabled) return;
      const pts = (data || originalGeojson).features.filter(f => f.geometry?.type === "Point");
      const halos = pts.map(f => turf.circle(f.geometry.coordinates, 289.7, { steps: 128, units: "kilometers" }));
      let merged = halos[0];
      for (let i = 1; i < halos.length; i++) {
        try { merged = turf.union(merged, halos[i]); } catch {}
      }
      setHaloData({ type: "FeatureCollection", features: merged ? [merged] : [] });
    }

    function buildFilters(gj) {
      const regionSelect = document.getElementById("regionFilter");
      const buSelect = document.getElementById("buFilter");
      regionSelect.innerHTML = ""; buSelect.innerHTML = "";

      const states = [...new Set(gj.features.filter(f => f.properties.country === "US").map(f => f.properties.state))].sort();
      const provinces = [...new Set(gj.features.filter(f => f.properties.country === "CAN").map(f => f.properties.state))].sort();
      const bus = [...new Set(gj.features.map(f => f.properties.bu).filter(Boolean))].sort();

      states.concat(provinces).forEach(s => {
        const o = document.createElement("option"); o.value = s; o.textContent = s; regionSelect.appendChild(o);
      });
      bus.forEach(b => {
        const o = document.createElement("option"); o.value = b; o.textContent = b; buSelect.appendChild(o);
      });

      function getSelected(sel) { return Array.from(sel.selectedOptions).map(o => o.value); }
      async function applyFilters() {
        const regions = getSelected(regionSelect);
        const busSel = getSelected(buSelect);
        const filtered = { type: "FeatureCollection", features: originalGeojson.features.filter(f => {
          const props = f.properties || {}; let ok = true;
          if (regions.length && props.state && !regions.includes(props.state)) ok = false;
          if (busSel.length && props.bu && !busSel.includes(props.bu)) ok = false;
          return ok;
        })};
        map.getSource(OFFICE_SOURCE).setData(filtered);
        if (reachEnabled) rebuildOfficeHalos(filtered);
      }
      regionSelect.addEventListener("change", applyFilters);
      buSelect.addEventListener("change", applyFilters);
      document.getElementById("clearRegion").addEventListener("click", () => { regionSelect.selectedIndex = -1; applyFilters(); });
      document.getElementById("clearBU").addEventListener("click", () => { buSelect.selectedIndex = -1; applyFilters(); });
      document.getElementById("clearFilters").addEventListener("click", () => {
        regionSelect.selectedIndex = -1; buSelect.selectedIndex = -1;
        map.getSource(OFFICE_SOURCE).setData(originalGeojson);
        if (reachEnabled) rebuildOfficeHalos(originalGeojson);
      });
    }

    map.on("load", async () => {
      const res = await fetch(DATA_URL);
      originalGeojson = await res.json();

      map.addSource(OFFICE_SOURCE, { type: "geojson", data: originalGeojson });
      map.addLayer({ id: OFFICE_LAYER, type: "circle", source: OFFICE_SOURCE, paint: { "circle-radius": 6, "circle-color": "#009de0" } });

      ensureHaloLayer();
      buildFilters(originalGeojson);

      // ðŸ‘‡ Focus map only on US + Canada
      map.fitBounds([[-168, 18], [-52, 75]]);
    });

    document.getElementById("reachOn").addEventListener("click", () => { reachEnabled = true; rebuildOfficeHalos(); });
    document.getElementById("reachOff").addEventListener("click", () => { reachEnabled = false; setHaloData(emptyFC()); });
  </script>
</body>
</html>
